// http://www.jasonkostempski.com/jQuery/Mimass
// (c)2009 Jason Kostempski

ï»¿
(function($){$.fn.mimass=function(settings){var options=$.extend({},$.fn.mimass.defaults,settings);var $div=getResultsDiv();var $activeInput=null;var currentRequest=null;var resultsData=[];var selectedIndex=-1;return this.each(function(){$this=$(this);$this.attr("autocomplete","off");$this.focus(focusWhisperer);$this.keydown(keyWhispererDown);$this.keyup(keyWhispererUp);$this.blur(blurWhisperer);});function focusWhisperer(e){$activeInput=$(this);};function keyWhispererDown(e){switch(e.keyCode){case 13:acceptSelection();e.preventDefault();break;case 37:case 39:case 9:acceptSelection();break;default:break;}};function keyWhispererUp(e){switch(e.keyCode){case 16:case 17:case 18:case 13:case 37:case 39:case 9:break;case 38:setSelectedIndex(selectedIndex-1);break;case 40:setSelectedIndex(selectedIndex+1);break;default:sendRequest();break;}};function blurWhisperer(e){if(selectedIndex==-1){hideDiv();abortCurrentRequest();}};function mouseWhispererOver(e){var index=$div.children().index(this);setSelectedIndex(index);};function sendRequest(){abortCurrentRequest();if($activeInput.val().length>0){currentRequest=$.getJSON(options.url,options.requestDataCallback($activeInput),requestComplete);}
else{hideDiv();}};function abortCurrentRequest(){if(currentRequest!==null&&currentRequest.readyState!=4){currentRequest.abort();}};function requestComplete(json){selectedIndex=-1;resultsData=json;$div.empty();$.each(resultsData,function(index){$div.append('<div style="cursor: default;">'+resultsData[index]+'</div>');$itemDiv=$div.children(":last");$itemDiv.mouseover(mouseWhispererOver);$itemDiv.click(function(e){acceptSelection();e.stopPropagation();});$div.mouseleave(clearSelectedItem);});if(resultsData.length>0){showDiv();}
else{hideDiv();}};function setSelectedIndex(index){if($div.css("display")=='none'){selectedIndex=-1;return;}
var itemDivs=$div.children();itemDivs.removeClass("ui-state-hover");selectedIndex=index;if(selectedIndex>=resultsData.length){selectedIndex=0;}
else if(selectedIndex<0){selectedIndex=resultsData.length-1;}
$(itemDivs[selectedIndex]).addClass("ui-state-hover");};function clearSelectedItem(){selectedIndex=-1;$div.children().removeClass("ui-state-hover");};function acceptSelection(){if(selectedIndex>-1){$activeInput.val(resultsData[selectedIndex]);hideDiv();}
selectedIndex=-1;};function getResultsDiv(){if($("div.mimass").length==0){$("body").append("<div style='display:none; position: absolute; width: auto; padding: 0.3em;' class='mimass ui-widget ui-widget-content'></div>");}
return $("div.mimass");};function showDiv(){if($div.css("display")=='none'){var pos=$activeInput.position();var hei=$activeInput.outerHeight();$div.css("top",pos.top+hei+2);$div.css("left",pos.left);$div.show('blind',{},100);}};function hideDiv(){$div.hide();};};$.fn.mimass.defaults={url:'.',requestDataCallback:function(input){return{text:input.val()};}};})(jQuery);